% Package for the common premable commands for
% Zhang Maiyun's Pearson College UWC documents
% Copyright (c) 2020-2024 Zhang Maiyun
%
% Try to keep future versions compatible with older ones.
% Files written for the older versions should produce approximately
% the same output with the newer versions.
%
% Obtain updates at
% https://github.com/myzhang1029/codes/blob/main/latex/pccommon.sty
%
% Based on csc_common.tex
% Options: bibstyle=stylename,paper=papergeom,cjkos=os
% License: CC BY-SA 4.0

% !TEX TS-program = xelatex
% !BIB TS-program = biber
% !TEX encoding = UTF-8 Unicode
%TC: macro \usetikzlibrary [ignore]
%TC: macro \usepgfplotslibrary [ignore]
%TC: macro \pgfplotsset [ignore]

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{pccommon}[2024/02/04 Pearson College UWC common]
\RequirePackage{xkeyval}
% Select the style of the citations
\def\pc@bibstyle{mla}
\DeclareOptionX{bibstyle}{\def\pc@bibstyle{#1}}
% Select the size of the page
\def\pc@paper{a4paper}
\DeclareOptionX{paper}{\def\pc@paper{#1}}
% Omit to disable CJK fonts, `linux' for GNU/Linux,
% `winold' for Windows <= XP, `winnew' for Windows >= Vista,
% `macold' for macOS <= Yosemite, `macnew' for macOS >= EL Capitan
\DeclareOptionX{cjkos}{\def\pc@cjkos{#1}}
\ProcessOptionsX

%%% Engine selection
\RequirePackage{iftex}
\RequirePackage{ifthen}

%%% SECTION TITLE APPEARANCE
\RequirePackage{sectsty}
%\allsectionsfont{\sffamily\mdseries\upshape} % (See the fntguide.pdf for font help)
% (This matches ConTeXt defaults)

%%% PACKAGES
\RequirePackage{graphicx} % support the \includegraphics command and options
\RequirePackage{wrapfig} % for wrapping figures around text
\RequirePackage{booktabs} % for much better looking tables
\RequirePackage{threeparttable} % three line style table with footnotes
\RequirePackage{multirow} % multi row table cells
%\RequirePackage{indentfirst} % optional, indent the first paragraph
\RequirePackage{array} % for better arrays (eg matrices) in maths
\RequirePackage{paralist} % very flexible & customisable lists (eg. enumerate/itemize, etc.)
\RequirePackage{verbatim} % adds environment for commenting out blocks of text & for better verbatim
\RequirePackage[normalem]{ulem}
\RequirePackage{makecell}
\RequirePackage{subfig} % make it possible to include more than one captioned figure/table in a single float
\RequirePackage{float}
\RequirePackage{amsmath}
\RequirePackage{amssymb}
\RequirePackage{amsthm}
\RequirePackage{mathtools}
\RequirePackage{derivative} % for \pdv, \odv, \odif, etc.
\RequirePackage{soul} % for much better underline, etc.
\RequirePackage{plimsoll} % for the Standard State symbol \stst
\RequirePackage[version=4]{mhchem} % typeset chemical formulas
\RequirePackage{siunitx} % typeset SI units
\sisetup{separate-uncertainty=true}
\RequirePackage{textcomp} % some other symbols
\RequirePackage[level]{fmtcount}
\RequirePackage{xcolor} % color names
\RequirePackage{csquotes}

%% Multilingual typesetting
\RequirePackage{fontspec}
% use main= so that subsequent stuff don't confuse babel
\RequirePackage[french,main=english]{babel}

% Compatibility with old LaTeX
\providecommand{\IfPackageAtLeastTF}[4]{%
  \@ifpackagelater{#1}{#2}{#3}{#4}%
}

% CJK configuration
% Note that this template is meant for a English-default document
% with possible CJK characters.
% These are only available in LuaLaTeX
\ifluatex{}
    \babelprovide[import,intraspace=0 .15 0,onchar=ids fonts]{chinese}
    \babelprovide[onchar=ids fonts]{french}
    \babelcharproperty{`“}{linebreak}{op}
    \babelcharproperty{`”}{linebreak}{cl}
    % https://tex.stackexchange.com/a/708645
    % Full info is latex3/babel#281
    \IfPackageAtLeastTF{babel}{2024/02/07}{}{%
    \let\bblorg@mapselect\bbl@mapselect
    \def\bbl@mapselect{\ifmmode\else\bblorg@mapselect\fi}}
\else
    \babelprovide[import,intraspace=0 .15 0]{chinese}
\fi

% Set up CJK fonts
\ifthenelse{\isundefined\pc@cjkos}{}{
    \ifthenelse{\equal\pc@cjkos{macnew}}{
        % >= EL Capitan
        \babelfont[chinese]{rm}[UprightFont=* Light,BoldFont=* Bold,ItalicFont=Kaiti SC,BoldItalicFont=Kaiti SC Bold]{Songti SC}
        \babelfont[chinese]{sf}{PingFang SC}
        \babelfont[chinese]{tt}{STFangsong}
    }{\ifthenelse{\equal\pc@cjkos{macold}}{
        % <= Yosemite
        \babelfont[chinese]{rm}[BoldFont=STHeiti,ItalicFont=STKaiti]{STSong}
        \babelfont[chinese]{sf}[BoldFont=STHeiti]{STXihei}
        \babelfont[chinese]{tt}{STFangsong}
    }{\ifthenelse{\equal\pc@cjkos{winnew}}{
        % >= Vista
        \babelfont[chinese]{rm}[BoldFont=SimHei,ItalicFont=KaiTi]{SimSun}
        \babelfont[chinese]{sf}[BoldFont={* Bold}]{Microsoft YaHei}
        \babelfont[chinese]{tt}{FangSong}
    }{\ifthenelse{\equal\pc@cjkos{winold}}{
        % <= XP
        \babelfont[chinese]{rm}[BoldFont=SimHei,ItalicFont=KaiTi_GB2312]{SimSun}
        \babelfont[chinese]{sf}{SimHei}
        \babelfont[chinese]{tt}{FangSong_GB2312}
    }{\ifthenelse{\equal\pc@cjkos{linux}}{
        % Fonts for Ubuntu
        \babelfont[chinese]{rm}[BoldFont=WenQuanYi Zen Hei,ItalicFont=AR PL UKai CN]{AR PL UMing CN}
        \babelfont[chinese]{sf}{WenQuanYi Zen Hei}
        \babelfont[chinese]{tt}{AR PL UMing CN}
    }{
        \errmessage{Incorrect OS specification for CJK fonts: `\pc@cjkos'}
    }}}}}
}

% Do this after languange stuff
\RequirePackage[style=\pc@bibstyle,backend=biber]{biblatex}

%% Stuff about drawing with TikZ and PGF
\RequirePackage{tikz} % drawing support
\usetikzlibrary{calc} % tikz point calculations
\RequirePackage{pgfplots} % plotting in tikz
\RequirePackage{pgfplotstable}
\pgfplotsset{compat=1.17, compat/show suggested version=false}
\usepgfplotslibrary{units}
\RequirePackage[american, europeanresistors, american voltages, straightvoltages, fetbodydiode]{circuitikz} % draw circuits
\RequirePackage{chemfig} % draw chemical structures

%%% ToC (table of contents) APPEARANCE
\RequirePackage[nottoc,notlof,notlot]{tocbibind} % Put the bibliography in the ToC
\RequirePackage[titles,subfigure]{tocloft} % Alter the style of the Table of Contents
\renewcommand{\cftsecfont}{\rmfamily\mdseries\upshape}
\renewcommand{\cftsecpagefont}{\rmfamily\mdseries\upshape} % No bold!

\RequirePackage[hidelinks]{hyperref} % Load hyperref BEFORE geometry

%%% PAGE DIMENSIONS
\RequirePackage{geometry} % to change the page dimensions
\geometry{\pc@paper}
\geometry{margin=1in} % for example, change the margins to 2 inches all round

%%% HEADERS & FOOTERS
\RequirePackage{fancyhdr} % This should be set AFTER setting up the page geometry
\pagestyle{fancy} % options: empty , plain , fancy
\renewcommand{\headrulewidth}{0pt} % customise the layout...
\lhead{}\chead{}\rhead{}
\lfoot{}\cfoot{\thepage}\rfoot{}

% Convenient centered three part table
\newenvironment{ctpt}{\center\threeparttable}{\endthreeparttable\endcenter}

% Circle any text from https://latex.org/forum/viewtopic.php?t=22367
\newcommand*\circled[1]{\tikz[baseline= (char.base)]{
  \node[shape=circle,draw,inner sep=1pt] (char) {#1};}}

%% Math stuff
% Theorems https://www.overleaf.com/learn/latex/Theorems_and_proofs
\newtheorem{theorem}{Theorem}[section]
\newtheorem{corollary}{Corollary}[theorem]
\newtheorem{lemma}[theorem]{Lemma}
\theoremstyle{remark}
\newtheorem*{remark}{Remark}
\theoremstyle{definition}
\newtheorem{definition}{Definition}[section]

% More operators to my taste
\DeclareMathOperator{\cis}{cis}
\DeclareMathOperator{\Var}{Var}
\DeclareMathOperator{\cov}{cov}
\DeclareMathOperator{\sgn}{sgn}
\newcommand*\dd{\mathrm{d}} % For old documents. Use \odif from the `derivative' package instead.
\newcommand*\ii{\ensuremath{i}}
\newcommand*\abs[1]{\left\lvert#1\right\rvert}
\newcommand*\norm[1]{\left\lVert#1\right\rVert}
\newcommand*\permu[2]{#1\text{P}#2}
\newcommand*\combi[2]{#1\text{C}#2}

% Centered title from https://stackoverflow.com/a/3142372
\newcommand{\mkctitle}{
    \begin{titlepage}
        \null{}  % Empty line
        \nointerlineskip{}  % No skip for prev line
        \vfill
        \let\snewpage\newpage
        \let\newpage \relax
        \maketitle
        \let\newpage\snewpage{}
        \vfill
        \break{} % page break
    \end{titlepage}
}
