% Package for the common preamble commands for
% Zhang Maiyun's Pearson College UWC documents and beyond.
% Copyright (C) 2020-2024 Zhang Maiyun
%
% Try to keep future versions compatible with older ones.
% Files written for the older versions should produce approximately
% the same output with the newer versions.
%
% Obtain updates at
% https://github.com/myzhang1029/codes/blob/main/latex/pccommon.sty
%
% Based on csc_common.tex
% Options: bibstyle=stylename,paper=papergeom,cjkos=os
% License: CC BY-SA 4.0

% !TEX TS-program = xelatex
% !BIB TS-program = biber
% !TEX encoding = UTF-8 Unicode
%TC: macro \usetikzlibrary [ignore]
%TC: macro \usepgfplotslibrary [ignore]
%TC: macro \pgfplotsset [ignore]

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{pccommon}[2024/05/02 Pearson College UWC common]
\RequirePackage{xkeyval}
% Select the style of the citations
\def\pccommon@bibstyle{mla}
\DeclareOptionX{bibstyle}{\def\pccommon@bibstyle{#1}}
% Select the size of the page
\def\pccommon@paper{a4paper}
\DeclareOptionX{paper}{\def\pccommon@paper{#1}}
% Omit to disable CJK fonts, `linux' for GNU/Linux,
% `winold' for Windows <= XP, `winnew' for Windows >= Vista,
% `macold' for macOS <= Yosemite, `macnew' for macOS >= EL Capitan
\DeclareOptionX{cjkos}{\def\pccommon@cjkos{#1}}
\ProcessOptionsX

%%% Engine selection
\RequirePackage{iftex}
\RequirePackage{ifthen}

%%% SECTION TITLE APPEARANCE
\RequirePackage{sectsty}
%\allsectionsfont{\sffamily\mdseries\upshape} % (See the fntguide.pdf for font help)
% (This matches ConTeXt defaults)

%%% PACKAGES
\RequirePackage{xurl} % Load first: allow multi-line URLs https://tex.stackexchange.com/a/54949
\RequirePackage{xparse}
\RequirePackage{graphicx} % support the \includegraphics command and options
\RequirePackage{wrapfig} % for wrapping figures around text
\RequirePackage{booktabs} % for much better looking tables
\RequirePackage{threeparttable} % three line style table with footnotes
\RequirePackage{multirow} % multi row table cells
%\RequirePackage{indentfirst} % optional, indent the first paragraph
\RequirePackage{array} % for better arrays (eg matrices) in maths
\RequirePackage{paralist} % very flexible & customisable lists (eg. enumerate/itemize, etc.)
\RequirePackage{verbatim} % adds environment for commenting out blocks of text & for better verbatim
\RequirePackage[normalem]{ulem}
\RequirePackage{makecell}
\RequirePackage{subfig} % make it possible to include more than one captioned figure/table in a single float
\RequirePackage{float}
\RequirePackage{amsmath}
\RequirePackage{amssymb}
\RequirePackage{amsthm}
\RequirePackage{mathtools}
\RequirePackage{bm} % bold math symbols. After amsmath
\RequirePackage{bbm} % blackboard math symbols
\RequirePackage{derivative} % for \pdv, \odv, \odif, etc.
\RequirePackage{soul} % for much better underline, etc.
\RequirePackage{plimsoll} % for the Standard State symbol \stst
\RequirePackage[version=4]{mhchem} % typeset chemical formulas
\RequirePackage{siunitx} % typeset SI units
\RequirePackage{textcomp} % some other symbols
\RequirePackage[level]{fmtcount}
\RequirePackage{xcolor} % color names
\RequirePackage{fvextra} % before csquotes and after xcolor
\RequirePackage{csquotes}

%% Multilingual typesetting
\RequirePackage{fontspec}
% use main= so that subsequent stuff don't confuse babel
\RequirePackage[provide=*,french,main=english]{babel}

% Compatibility with old LaTeX
\providecommand{\IfPackageAtLeastTF}[4]{%
  \@ifpackagelater{#1}{#2}{#3}{#4}%
}

% CJK configuration
% Note that this template is meant for a English-default document
% with possible CJK characters.
% Not using `import`; passing `provide=*` to babel instead
% These are only available in LuaLaTeX
\ifluatex{}
    \babelprovide[intraspace=0 .15 0,onchar=ids fonts]{chinese}
    \babelprovide[onchar=ids fonts]{french}
    \babelcharproperty{`“}{linebreak}{op}
    \babelcharproperty{`”}{linebreak}{cl}
    % https://tex.stackexchange.com/a/708645
    % Full info is latex3/babel#281
    \IfPackageAtLeastTF{babel}{2024/02/07}{}{%
    \let\bblorg@mapselect\bbl@mapselect
    \def\bbl@mapselect{\ifmmode\else\bblorg@mapselect\fi}}
\else
    \babelprovide[intraspace=0 .15 0]{chinese}
\fi

% Set up CJK fonts
\ifthenelse{\isundefined\pccommon@cjkos}{}{
    \ifthenelse{\equal\pccommon@cjkos{macnew}}{
        % >= EL Capitan
        \babelfont[chinese]{rm}[UprightFont=* Light,BoldFont=* Bold,ItalicFont=Kaiti SC,BoldItalicFont=Kaiti SC Bold]{Songti SC}
        \babelfont[chinese]{sf}{PingFang SC}
        \babelfont[chinese]{tt}{STFangsong}
    }{\ifthenelse{\equal\pccommon@cjkos{macold}}{
        % <= Yosemite
        \babelfont[chinese]{rm}[BoldFont=STHeiti,ItalicFont=STKaiti]{STSong}
        \babelfont[chinese]{sf}[BoldFont=STHeiti]{STXihei}
        \babelfont[chinese]{tt}{STFangsong}
    }{\ifthenelse{\equal\pccommon@cjkos{winnew}}{
        % >= Vista
        \babelfont[chinese]{rm}[BoldFont=SimHei,ItalicFont=KaiTi]{SimSun}
        \babelfont[chinese]{sf}[BoldFont={* Bold}]{Microsoft YaHei}
        \babelfont[chinese]{tt}{FangSong}
    }{\ifthenelse{\equal\pccommon@cjkos{winold}}{
        % <= XP
        \babelfont[chinese]{rm}[BoldFont=SimHei,ItalicFont=KaiTi_GB2312]{SimSun}
        \babelfont[chinese]{sf}{SimHei}
        \babelfont[chinese]{tt}{FangSong_GB2312}
    }{\ifthenelse{\equal\pccommon@cjkos{linux}}{
        % Fonts for Ubuntu
        \babelfont[chinese]{rm}[BoldFont=WenQuanYi Zen Hei,ItalicFont=AR PL UKai CN]{AR PL UMing CN}
        \babelfont[chinese]{sf}{WenQuanYi Zen Hei}
        \babelfont[chinese]{tt}{AR PL UMing CN}
    }{
        \errmessage{Incorrect OS specification for CJK fonts: `\pccommon@cjkos'}
    }}}}}
}

% Do this after languange stuff
\RequirePackage[style=\pccommon@bibstyle,backend=biber]{biblatex}

%% Stuff about drawing with TikZ and PGF
\RequirePackage{tikz} % drawing support
\usetikzlibrary{calc} % tikz point calculations
\RequirePackage{pgfplots} % plotting in tikz
\RequirePackage{pgfplotstable}
\pgfplotsset{compat=1.17, compat/show suggested version=false}
\usepgfplotslibrary{units}
\RequirePackage[american, europeanresistors, american voltages, straightvoltages, fetbodydiode]{circuitikz} % draw circuits
\RequirePackage{chemfig} % draw chemical structures

%%% ToC (table of contents) APPEARANCE
\RequirePackage[nottoc,notlof,notlot]{tocbibind} % Put the bibliography in the ToC
\RequirePackage[titles,subfigure]{tocloft} % Alter the style of the Table of Contents
\renewcommand{\cftsecfont}{\rmfamily\mdseries\upshape}
\renewcommand{\cftsecpagefont}{\rmfamily\mdseries\upshape} % No bold!

\RequirePackage[hidelinks]{hyperref} % Load hyperref BEFORE geometry

%%% PAGE DIMENSIONS
\RequirePackage{geometry} % to change the page dimensions
\geometry{\pccommon@paper}
\geometry{margin=1in} % for example, change the margins to 2 inches all round

%%% HEADERS & FOOTERS
\RequirePackage{fancyhdr} % This should be set AFTER setting up the page geometry
\pagestyle{fancy} % options: empty , plain , fancy
\renewcommand{\headrulewidth}{0pt} % customise the layout...
\lhead{}\chead{}\rhead{}
\lfoot{}\cfoot{\thepage}\rfoot{}


%%% Definitions

%% Math
% Theorems https://www.overleaf.com/learn/latex/Theorems_and_proofs
\newtheorem{theorem}{Theorem}[section]
\newtheorem{corollary}{Corollary}[theorem]
\newtheorem{lemma}[theorem]{Lemma}
\theoremstyle{remark}
\newtheorem*{remark}{Remark}
\theoremstyle{definition}
\newtheorem{definition}{Definition}[section]

% More operators to my taste
\DeclareMathOperator{\cis}{cis} % cosine + i sine
\DeclareMathOperator{\Var}{Var} % Variance
\DeclareMathOperator{\cov}{cov} % Covariance
\DeclareMathOperator{\sgn}{sgn} % Sign function
\DeclareMathOperator{\Span}{Span} % Span of a set of vectors
\DeclareMathOperator{\colspace}{colspace} % Column space of a matrix
\DeclareMathOperator{\img}{img} % Image of a matrix/map
\DeclareMathOperator{\rank}{rank} % Rank of a matrix
\DeclareMathOperator{\vol}{vol} % Volume of something
\DeclareMathOperator{\trace}{tr} % Trace
\newcommand*{\dd}{\mathrm{d}} % For old documents. Use \odif from the `derivative' package instead.
\newcommand*{\ii}{\ensuremath{i}} % Imaginary unit
\newcommand*{\charf}{\mathbbm{1}} % Characteristic function
\newcommand*{\orderof}[1]{o(#1)} % Infinitesimal term of an order
\newcommand*{\vect}[1]{\bm{\mathrm{#1}}} % Vec is bold no arrow
\newcommand*{\arrowvec}[1]{\vec{#1}} % Arrowed vector
\newcommand*{\abs}[1]{\left\lvert#1\right\rvert}
\newcommand*{\norm}[1]{\left\lVert#1\right\rVert}
\newcommand*{\permu}[2]{#1\text{P}#2} % Permutation
\newcommand*{\combi}[2]{#1\text{C}#2} % Combination
\newcommand*{\tr}{^\intercal} % Transpose
% \matdim{m}{n}{A} produces A with m x n below
\newcommand*{\matdim}[3]{\underset{#1 \times #2}{#3}}
% Augmented matrix https://tex.stackexchange.com/a/2238
\newenvironment{amatrix}[1]{\left[\begin{array}{@{}*{#1}{c}|c@{}}}{\end{array}\right]}
\newcommand*{\closure}[1]{\overline{#1}} % Closure of a set
\newcommand*{\interior}[1]{\mathring{#1}} % Interior of a set
% I found any bold nabla to be ugly
\newcommand*{\grad}{\arrowvec{\nabla}} % Gradient
% Partial derivative as used in John and Barbara Hubbard's Vector Calculus
% `\Ddif{function}` gives D function (full derivative)
% `\Ddif[variables]{function}` gives D_variable1 D_variable2 function
% `\Ddif[variables][orders]{function}` gives D_variable1^order1 D_variable2^order2 function
\NewDocumentCommand{\Ddif}{o o m}{%
    \IfNoValueTF{#1}{\mathbf{D} #3}{
        \IfPackageAtLeastTF{derivative}{2023/07/26}{%
            \IfNoValueTF{#2}
                {\mdv[style-var-!=mixed]{#3}!{#1}}
                {\mdv[style-var-!=mixed, order={#2}]{#3}!{#1}}
        }{\PackageError{pccommon}{Please~update~the~derivative~package}{Needs~at~least~v1.3}}
    }
}
\ExplSyntaxOn
% Vector differentials as used in John and Barbara Hubbard's Vector Calculus
% `\vdif{x,y,z}` gives |dx dy dz|
% `\vdif[2,n,1]{x,y,z}` gives |d^2x d^ny dz|
% `\vdif*` typesets variables as scalars
\newcommand*{\__pccommon_maybevect}[2]{\IfBooleanTF{#1}{#2}{\vect{#2}}}
% In Python I would use `zip`...
\int_new:N \g__pccommon_varidx_int
\NewDocumentCommand{\vdif}{s o m}{
    \abs{\IfNoValueTF{#2}
        % No orders
        {\clist_map_inline:nn{#3}{\odif{\__pccommon_maybevect{#1}{##1}}}}
        % Has orders
        {\ifnum\clist_count:n{#3}=\clist_count:n{#2}
            % Correct alignment
            {
                \int_set:Nn \g__pccommon_varidx_int {1}
                \clist_map_inline:nn{#2}{
                    \ifx1##1
                        % Skip if order is 1
                        \odif{\__pccommon_maybevect{#1}{\clist_item:nn{#3}{\g__pccommon_varidx_int}}}
                    \else
                        \odif[order={##1}]{\__pccommon_maybevect{#1}{\clist_item:nn{#3}{\g__pccommon_varidx_int}}}
                    \fi
                    \int_incr:N \g__pccommon_varidx_int
                }
            }
        \else
            \PackageError{pccommon}{Orders~mismatch~variables}{}
        \fi}}
}
% Elementary differential forms:
% `\dform{1,2,3}` gives dx_1 dx_2 dx_3
% `\dform[x,y,z]{1,2,3}` gives dx_1 dy_2 dz_3
% `\dform*{x,y,z}` gives dx dy dz
\NewDocumentCommand{\dform}{s o m}{
    \IfBooleanTF{#1}
        % Variable names mode (simple)
        {\odif{#3}}
        % Indices mode
        {
            \IfNoValueTF{#2}
                % No variable names, use x
                {\clist_map_inline:nn{#3}{\odif{x\c_math_subscript_token{##1}}}}
                % Has variable names
                {\ifnum\clist_count:n{#2}=\clist_count:n{#3}
                    % Correct alignment
                    {
                        \int_set:Nn \g__pccommon_varidx_int {1}
                        \clist_map_inline:nn{#3}{
                            \odif{{\clist_item:nn{#2}{\g__pccommon_varidx_int}}\c_math_subscript_token{##1}}
                            \int_incr:N \g__pccommon_varidx_int
                        }
                    }
                \else
                    \PackageError{pccommon}{Variables~mismatch~indices}{}
                \fi}
        }
}
\ExplSyntaxOff
% Tangent space
\newcommand*{\Tspace}[2]{\mathbf{T}_{#1} #2}
% Jacobian of a function
\newcommand*{\jadif}[1]{\mathbf{J} {#1}}
% Taylor polynomial \taylor{order,function,center}
\newcommand*{\pccommon@taylor@format}[3]{\mathcal{P}_{#2,#3}^{#1}}
\def\pccommon@taylor@parseargs#1,#2,#3\relax{\pccommon@taylor@format{#1}{#2}{#3}}
\newcommand*{\taylor}[1]{\pccommon@taylor@parseargs#1\relax}

%% siunitx
\sisetup{%
    separate-uncertainty=true,
    separate-uncertainty-units=bracket,
    per-mode=power}
\DeclareSIUnit\parsec{pc}
% Defined but deprecated
\DeclareSIUnit\atomicmassunit{u}

%% Physics
% Typeset quantity dimension with a siunitx-like syntax
% Just a very crude parser compared to siunitx...
% Possible macros inside the argument of \qtydim:
% \tothe{<exponent>}: same as in siunitx
% \squared: same as in siunitx
% \cubed: same as in siunitx
% \time: T
% \length: L
% \mass: M
% \current: I
% \temperature: \Theta
% \amount: N
% \luminousintensity: J
\newcommand*{\qtydim}[1]{%
    \begingroup
        \def\tothe{^}%
        \def\squared{^2}%
        \def\cubed{^3}%
        \def\time{\mathrm{T}}%
        \def\length{\mathrm{L}}%
        \def\mass{\mathrm{M}}%
        \def\current{\mathrm{I}}%
        \def\temperature{\Theta}%
        \def\amount{\mathrm{N}}%
        \def\luminousintensity{\mathrm{J}}%
        \ensuremath{#1}%
    \endgroup
}
% Engineering notation vectors
\newcommand*{\uvecx}{\hat{\vect{i}}}
\newcommand*{\uvecy}{\hat{\vect{j}}}
\newcommand*{\uvecz}{\hat{\vect{k}}}
\newcommand*{\uvecr}{\hat{\vect{r}}}
\newcommand*{\uvecphi}{\hat{\vect{\phi}}}
\newcommand*{\uvectheta}{\hat{\vect{\theta}}}

%% Other stuff
% Convert numbers to Chinese
% Literal reading without decimal weights
\newcommand*{\pccommon@mnonescirczero}[1]{%
    \ifcase#1 〇\or 一\or 二\or 三\or 四\or 五\or 六\or 七\or 八\or 九\fi}
\newcommand*{\chinesenumcirczero}[1]{%
    \ifnum#1<10
        \pccommon@mnonescirczero{#1}%
    \else
        \expandafter\chinesenumcirczero\expandafter{\number\numexpr#1/10\relax}%
        \pccommon@mnonescirczero{\number\numexpr#1-10*(#1/10)\relax}%
    \fi}
% Normal reading
% \chinesenum{1042}: 一千零四十二
% \chinesenum{1000}: 一千
% \chinesenum{9003}: 九千零三
\newcommand*{\pccommon@mnones}[1]{%
    \ifcase#1 零\or 一\or 二\or 三\or 四\or 五\or 六\or 七\or 八\or 九\fi}
\newcommand*{\pccommon@mntens}[1]{%
    \ifnum#1<10
        \pccommon@mnones{#1}%
    \else
        \ifnum#1=10
            十%
        \else
            \ifnum\numexpr(#1/10)*10\relax=#1
                \pccommon@mnones{\numexpr#1/10\relax}十%
            \else
                \pccommon@mnones{\numexpr#1/10\relax}十\pccommon@mnones{\numexpr#1-10*(#1/10)\relax}%
            \fi
        \fi
    \fi}
\newcommand*{\pccommon@mnhundreds}[1]{%
    \ifnum#1<100
        \pccommon@mntens{#1}%
    \else
        \ifnum\numexpr(#1/100)*100\relax=#1
            \pccommon@mnones{\numexpr#1/100\relax}百%
        \else
            \pccommon@mnones{\numexpr#1/100\relax}百%
            \ifnum\numexpr#1-100*(#1/100)\relax<10
                零%
            \fi
            \pccommon@mntens{\numexpr#1-100*(#1/100)\relax}%
        \fi
    \fi}
\newcommand*{\pccommon@mnthousands}[1]{%
    \ifnum#1<1000
        \pccommon@mnhundreds{#1}%
    \else
        \ifnum\numexpr(#1/1000)*1000\relax=#1
            \pccommon@mnones{\numexpr#1/1000\relax}千%
        \else
            \pccommon@mnones{\numexpr#1/1000\relax}千%
                \ifnum\numexpr#1-1000*(#1/1000)\relax<100
                    零%
                \fi
            \pccommon@mnhundreds{\numexpr#1-1000*(#1/1000)\relax}%
        \fi
    \fi}
\newcommand*{\chinesenum}[1]{%
    \ifnum#1<10000
        \pccommon@mnthousands{#1}%
    \else
        \PackageError{pccommon}{Number~for~Chinese~conversion~too~large}{}
    \fi}

% Convenient centered three part table
\newenvironment{ctpt}{\center\threeparttable}{\endthreeparttable\endcenter}

% Circle any text from https://latex.org/forum/viewtopic.php?t=22367
\newcommand*{\circled}[1]{\tikz[baseline= (char.base)]{
  \node[shape=circle,draw,inner sep=1pt] (char) {#1};}}

% Centered title from https://stackoverflow.com/a/3142372
\newcommand{\mkctitle}{
    \begin{titlepage}
        \null{}  % Empty line
        \nointerlineskip{}  % No skip for prev line
        \vfill
        \let\snewpage\newpage
        \let\newpage \relax
        \maketitle
        \let\newpage\snewpage{}
        \vfill
        \break{} % page break
    \end{titlepage}
}
